@ECHO OFF
REM  This script was generated by epm for sandbox command
REM  {{ name }} of profile {{ profile.name }} scheme {{ scheme.name }}
REM  and this is windows shell script in order to run linux
REM  program with Windows Docker Desktop
REM
REM  You can use environment vars to run on shell or docker
REM   EPM_SANDBOX_STORAGE: path
REM      conan storage path, if not set use ~/.conan/data
REM
REM   EPM_SANDBOX_IMAGE:
REM      specified docker image name to run this program
REM      default: {{ profile.docker.runner.image }}
REM   EPM_SANDBOX_SHELL:
REM      specified docker's shell to exec program
REM      default: {{ profile.docker.runner.shell }}
REM
REM  normally you should invoke this in project directory
REM  .epm/{{ folder.name }}/sandbox/{{name}}
REM 
REM  Actually, you do not have to call this script directly.
REM  You should use epm sandbox command like below 
REM  !!! MAKE SURE you are in project directory
REM     epm sandbox --profile {{ profile.name }} {{ '--scheme %s' % scheme.name if scheme.name else '' }} {{ name }}
REM ##########################################################
SETLOCAL

set _SHELL=%EPM_SANDBOX_SHELL%
set _IMAGE=%EPM_SANDBOX_IMAGE%
set _HOME=%EPM_SANDBOX_HOME%
if not defined EPM_SANDBOX_IMAGE set _IMAGE={{ image }}
if not defined EPM_SANDBOX_SHELL set _SHELL={{ shell }}
if not defined EPM_SANDBOX_HOME set _HOME={{ home }}
if not defined EPM_SANDBOX_PROJECT set EPM_SANDBOX_PROJECT=%CD%
if not defined EPM_SANDBOX_STORAGE (
    if defined CONAN_STORAGE_PATH (
        set EPM_SANDBOX_STORAGE=%CONAN_STORAGE_PATH%
    ) else (
        set EPM_SANDBOX_STORAGE=%USERPROFILE%\.epm\.conan\data
    )
)

if not exist %EPM_SANDBOX_STORAGE% mkdir %EPM_SANDBOX_STORAGE%

set _CMD=docker run -it --rm --name sandbox.{{ name }}
set _CMD=%_CMD% -v %EPM_SANDBOX_STORAGE%:%_HOME%/@host/conan.storage
set _CMD=%_CMD% -v %EPM_SANDBOX_PROJECT%:%_HOME%/@host/project
set _CMD=%_CMD% -e EPM_SANDBOX_HOME=%_HOME
set _CMD=%_CMD% -e EPM_SANDBOX_STORAGE=%_HOME%/@host/conan.storage
set _CMD=%_CMD% -e EPM_SANDBOX_PROJECT=%_HOME%/@host/project
set _CMD=%_CMD% -w %_HOME%
set _CMD=%_CMD% %_IMAGE% %_SHELL%
set _CMD=%_CMD% %_HOME%/@host/project/.epm/{{ scheme }}/sandbox/{{ name }} %*

%_CMD%

ENDLOCAL


