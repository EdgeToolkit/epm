# This script was generated by epm for sandbox command 
# {{ name }} of scheme {{ scheme }}
# You can use environment vars to run on shell or docker
#  EPM_SANDBOX_RUNNER: [docker, shell]
#     if not set and docker installed, then use docker,
#     otherwise use shell
#  EPM_SANDBOX_STORAGE: path
#     conan storage path, if not set use ~/.conan/data
#
# normally you should invoke this in project directory
# ./epm/{{ configuration }}/sandbox/{{name}}
#
# Actually, you do not have to call this script directly.
# You should use epm sandbox command like below 
# !!! MAKE SURE you are in project directory
#    epm sandbox --scheme {{ scheme }} {{ name }}
###########################################################
_runner=$EPM_SANDBOX_RUNNER
_storage=$EPM_SANDBOX_STORAGE
_sudo=$EPM_SANDBOX_SUDO
_project=$EPM_SANDBOX_PROJECT

[[ -z $_storage ]] && _storage=$CONAN_STORAGE_PATH
[[ -z $_storage ]] && _storage=~/.conan/data
[[ -z $_runner  ]] && _runner='auto'
[[ -z $_project  ]] && _project=$PWD

if [[ -z $_sudo ]]; then
  $(which sudo > /dev/null)
  if [[ -$? -eq 0 ]]; then
    _sudo=yes
  else
    _sudo=no
  fi
fi

if [[ -z $_runner || $_runner == auto ]]; then
  $(which docker > /dev/null)
  _has_docker=$?
  if [[ "$_has_docker" == "0" ]]; then
    _runner='docker'
  else
    _runner='shell'
  fi
fi

_mount()
{
    storage=$2

    if [[ $_sudo == yes ]]; then
      sudo rm -rf /mnt/epm/sandbox
      sudo mkdir -p /mnt/epm/sandbox
      sudo chmod 777 /mnt/epm/sandbox
    else
      rm -rf /mnt/epm/sandbox
      mkdir -p /mnt/epm/sandbox
    fi
    
    mkdir -p /mnt/epm/sandbox/lib
    mkdir -p /mnt/epm/sandbox/bin

    {% for libname, lib in dylibs.items() %}
    ln -s {{ lib['target']}} /mnt/epm/sandbox/lib/{{ libname }}
    {% endfor %}

    ln -s {{ filename }} /mnt/epm/sandbox/bin/{{ name }}

}

#
#
#
set -e

if [[ $_runner == shell ]]; then
   _mount $_storage
   export LD_LIBRARY_PATH=/mnt/epm/sandbox/lib:$LD_LIBRARY_PATH
   /mnt/epm/sandbox/bin/{{ name }} {{ arguments }} $*
else
  _image=$EPM_SANDBOX_IMAGE
  [[ -z $_image ]] && _image={{ image }}
  _CMD="docker run -it --rm --name sandbox.{{ name }}"
  _CMD=" $_CMD -v $_storage:/mnt/epm/conan"
  _CMD=" $_CMD -e EPM_SANDBOX_STORAGE=/mnt/epm/conan"
  _CMD=" $_CMD -w /mnt/epm/project"
  _CMD=" $_CMD $_image {{ shell }}"
  _CMD=" $_CMD /mnt/epm/project/sandbox/bin/{{ name }} $*"
  sudo $_CMD

fi