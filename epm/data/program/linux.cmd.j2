{%- set profile = project.profile -%}
{%- set scheme = project.scheme -%}
{%- set name = name or project.name -%}
{%- set docker = profile.docker.runner or {} -%}
@ECHO OFF
REM  This script was generated by epm for sandbox command
REM  {{ name }} of profile {{ profile.name }} scheme {{ scheme.name }}
REM  and this is windows shell script in order to run linux
REM  program with Windows Docker Desktop
REM
REM  You can use environment vars to run on shell or docker
REM   EPM_SANDBOX_STORAGE: path
REM      conan storage path, if not set use ~/.conan/data
REM
REM   EPM_SANDBOX_IMAGE:
REM      specified docker image name to run this program
REM      default: {{ profile.docker.runner.image }}
REM   EPM_SANDBOX_SHELL:
REM      specified docker's shell to exec program
REM      default: {{ profile.docker.runner.shell }}
REM
REM  normally you should invoke this in project directory
REM  .epm/{{ project.folder.name }}/sandbox/{{name}}
REM 
REM  Actually, you do not have to call this script directly.
REM  You should use epm sandbox command like below 
REM  !!! MAKE SURE you are in project directory
REM     epm sandbox --profile {{ profile.name }} {{ '--scheme %s' % scheme.name if scheme.name else '' }} {{ name }}
REM ##########################################################
SETLOCAL

set _DIMAGE={{ docker['image'] }}
set _DSHELL={{ docker['shell'] }}
set _DHOME={{ docker['home'] }}

if NOT "%EPM_SANDBOX_DOCKER_IMAGE%" == "" set _DIMAGE=%EPM_SANDBOX_DOCKER_IMAGE%
if NOT "%EPM_SANDBOX_DOCKER_SHELL%" == "" set _DSHELL=%EPM_SANDBOX_DOCKER_SHELL%
if NOT "%EPM_SANDBOX_DOCKER_HOME%" == "" set _DHOME=%EPM_SANDBOX_DOCKER_HOME%

if NOT defined EPM_SANDBOX_PROJECT set EPM_SANDBOX_PROJECT=%CD%

REM guess storage path if not set EPM_SANDBOX_STORAGE
if not defined EPM_SANDBOX_STORAGE (
    if defined CONAN_STORAGE_PATH (
        set EPM_SANDBOX_STORAGE=%CONAN_STORAGE_PATH%
    ) else (
        if defined EPM_HOME_DIR (
            set EPM_SANDBOX_STORAGE=%EPM_HOME_DIR%\.conan\data
        ) else (
            set EPM_SANDBOX_STORAGE=%USERPROFILE%\.epm
        )
        
    )
)
pushd %EPM_SANDBOX_STORAGE%
set EPM_SANDBOX_STORAGE=%CD%
popd

if not exist %EPM_SANDBOX_STORAGE% mkdir %EPM_SANDBOX_STORAGE%

set _CMD=docker run -t --rm --name sandbox.{{ name }}
set _CMD=%_CMD% -v %EPM_SANDBOX_STORAGE%:%_DHOME%/@host/conan.storage
set _CMD=%_CMD% -v %EPM_SANDBOX_PROJECT%:%_DHOME%/@host/project
set _CMD=%_CMD% -e EPM_SANDBOX_HOME=%_DHOME%
set _CMD=%_CMD% -e EPM_SANDBOX_STORAGE=%_DHOME%/@host/conan.storage
set _CMD=%_CMD% -e EPM_SANDBOX_PROJECT=%_DHOME%/@host/project
set _CMD=%_CMD% -w %_DHOME%
set _CMD=%_CMD% %_DIMAGE% %_DSHELL%
set _CMD=%_CMD% %_DHOME%/@host/project/.epm/{{ project.folder.name }}/sandbox/{{executable.name}} %*

%_CMD%

ENDLOCAL


