@ECHO OFF
{#  #}
{%- set profile = project.profile -%}
{%- set scheme = project.scheme -%}
{%- set name = name or project.name %}
{%- set docker = profile.docker.runner or {} -%}
{%- set filename=filename.replace('/', '\\') -%}
{%- set program_dir = "{}/{}".format(project.path.program, executable.name)-%}
REM  This script was generated by epm for program running sandbox environment
REM  {{ name }} of profile {{ profile.name }} scheme {{ scheme.name }}
REM
REM  You can use environment vars to run on shell or docker
REM   EPM_SANDBOX_STORAGE: path
REM      conan storage path, if not set use ~/.epm/.conan/data
REM   EPM_SANDBOX_PROJECT: path
REM      work/project directory, if not set use current dir
REM
REM  normally you should invoke this in project directory
REM  .epm\{{ project.path.sandbox | win_path }}\{{name}}\.{{name}}
REM 
REM  You run it with epm command, but make sure you are in project directory
REM     epm sandbox --profile {{ profile.name }} {{ '--scheme %s' % scheme.name if scheme.name else '' }} {{ name }}
REM #############################################################

SETLOCAL
set EPM_SANDBOX_PACKAGE_NAME={{project.name}}
set EPM_SANDBOX_PACKAGE_VERSION={{project.version}}
set EPM_SANDBOX_PACKAGE_REFERENCE={{project.reference}}
set EPM_SANDBOX_PACKAGE_REFERENCE_DIR={{project.reference.dir_repr() | replace('/', '\\')}}
set EPM_SANDBOX_PACKAGE_ID={{package_id}}


REM guess storage path if not set EPM_SANDBOX_STORAGE
if not defined EPM_SANDBOX_STORAGE (
    if defined CONAN_STORAGE_PATH (
        set EPM_SANDBOX_STORAGE=%CONAN_STORAGE_PATH%
    ) else (
        if defined EPM_HOME_DIR (
            set EPM_SANDBOX_STORAGE=%EPM_HOME_DIR%\.conan\data
        ) else (
            set EPM_SANDBOX_STORAGE=%USERPROFILE%\.epm
        )
        
    )
)
pushd %EPM_SANDBOX_STORAGE%
set EPM_SANDBOX_STORAGE=%CD%
popd

if not defined EPM_SANDBOX_PROJECT set EPM_SANDBOX_PROJECT=%CD%

REM set the program package directory for {{ command }} of command.
{% if command == 'create' %}
set EPM_SANDBOX_PACKAGE_DIR=%EPM_SANDBOX_STORAGE%\%EPM_SANDBOX_PACKAGE_REFERENCE_DIR%\package\%EPM_SANDBOX_PACKAGE_ID%
{#
REM if defined EPM_SANDBOX_ARCHIVE (
REM     set EPM_SANDBOX_PACKAGE_DIR=%EPM_SANDBOX_ARCHIVE%\%EPM_SANDBOX_PACKAGE_REFERENCE_DIR%\package\%EPM_SANDBOX_PACKAGE_ID%
REM     set EPM_SANDBOX_PACKAGE_ROOTPATH=%EPM_SANDBOX_ARCHIVE%
REM ) else (
REM    set EPM_SANDBOX_PACKAGE_DIR=%EPM_SANDBOX_STORAGE%\%EPM_SANDBOX_PACKAGE_REFERENCE_DIR%\package\%EPM_SANDBOX_PACKAGE_ID%
REM    set EPM_SANDBOX_PACKAGE_ROOTPATH=%EPM_SANDBOX_STORAGE%
REM )
#}
set _LIBDIRS=
{%- for i in dirs.lib %}
set _LIBDIRS=%EPM_SANDBOX_STORAGE%\{{i}};%_LIBDIRS%
{%- endfor %}

{%- else %}

set _PROJECT_OUT_DIR=%EPM_SANDBOX_PROJECT%\{{project.path.out | win_path}}
set _LIBDIRS= %EPM_SANDBOX_PACKAGE_DIR%\bin;%_PROJECT_OUT_DIR%\build\bin

{%- endif %}


{% for i in dirs.dep %}
set _LIBDIRS=%_LIBDIRS%;%EPM_SANDBOX_STORAGE%\{{ i }}
{% endfor %}

PATH=%_LIBDIRS%;%_PATH%


{% if where == 'project' %}
set filename=%EPM_SANDBOX_PROJECT%\{{program_dir | win_path}}\{{filename}}
{% else %}
set filename=%EPM_SANDBOX_PACKAGE_DIR%\{{filename}}
{% endif %}

%filename% {{ arguments }} %*

ENDLOCAL



