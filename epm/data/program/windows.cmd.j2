@ECHO OFF
{% set profile = project.profile %}
{% set scheme = project.scheme %}
{% set name = name or project.name %}
{% set docker = profile.docker.runner or {} %}
{% set filename=filename.replace('/', '\\')%}
{% set program_dir = "{}/{}".format(project.folder.program, executable.name)%}
{% set program_dir = program_dir.replace('/', '\\') %}
REM  This script was generated by epm for program running sandbox environment
REM  {{ name }} of profile {{ profile.name }} scheme {{ scheme.name }}
REM
REM  You can use environment vars to run on shell or docker
REM   EPM_SANDBOX_STORAGE: path
REM      conan storage path, if not set use ~/.epm/.conan/data
REM   EPM_SANDBOX_PROJECT: path
REM      work/project directory, if not set use current dir
REM
REM  normally you should invoke this in project directory
REM  .epm\{{ project.folder.name }}\sandbox\{{name}}\.{{name}}
REM 
REM  You run it with epm command, but make sure you are in project directory
REM     epm sandbox --profile {{ profile.name }} {{ '--scheme %s' % scheme.name if scheme.name else '' }} {{ name }}
REM #############################################################

SETLOCAL
set EPM_SANDBOX_PACKAGE_NAME={{project.name}}
set EPM_SANDBOX_PACKAGE_VERSION={{project.version}}
set EPM_SANDBOX_PACKAGE_REFERENCE={{project.reference}}
set EPM_SANDBOX_PACKAGE_REFERENCE_DIR={{project.reference.dir_repr() | replace('/', '\\')}}
set EPM_SANDBOX_PACKAGE_ID={{package_id}}

if not defined EPM_SANDBOX_STORAGE (
    if defined CONAN_STORAGE_PATH (
        set EPM_SANDBOX_STORAGE=%CONAN_STORAGE_PATH%
    ) else (
        set EPM_SANDBOX_STORAGE=%USERPROFILE%\.epm\.conan\data
    )
)

if not defined EPM_SANDBOX_PROJECT set EPM_SANDBOX_PROJECT=%CD%
set _LIBDIRS=

{% if command == 'create' %}
if defined EPM_SANDBOX_ARCHIVE (
    set EPM_SANDBOX_PACKAGE_DIR=%EPM_SANDBOX_ARCHIVE%\%EPM_SANDBOX_PACKAGE_REFERENCE_DIR%\package\%EPM_SANDBOX_PACKAGE_ID%
) else (
    set EPM_SANDBOX_PACKAGE_DIR=%EPM_SANDBOX_STORAGE%\%EPM_SANDBOX_PACKAGE_REFERENCE_DIR%\package\%EPM_SANDBOX_PACKAGE_ID%
)
{% for i in libs %}
set _LIBDIRS=%_LIBDIRS%;%EPM_SANDBOX_PACKAGE_DIR%\{{i}}
{% endfor %}
{% else %}
set _PROJECT_OUT_DIR=%EPM_SANDBOX_PROJECT%\{{project.folder.out | replace('/', '\\')}}
set EPM_SANDBOX_PACKAGE_DIR=%_PROJECT_OUT_DIR%\package
set _LIBDIRS= %EPM_SANDBOX_PACKAGE_DIR%\bin;%_PROJECT_OUT_DIR%\build\bin
{% endif %}


{% for i in deps %}
set _LIBDIRS=%_LIBDIRS%;%EPM_SANDBOX_STORAGE%\{{ i }}
{% endfor %}
set _PATH=%PATH%
PATH=%_LIBDIRS%;%_PATH%


{% if where == 'project' %}
set filename=%EPM_SANDBOX_PROJECT%\{{program_dir}}\{{filename}}
{% else %}
set filename=%EPM_SANDBOX_PACKAGE_DIR%\{{filename}}
{% endif %}

if defined EPM_SANDBOX_VERBOSE (
echo ""========== Package libraries directory =================="
echo "%_LIBDIRS%"
echo "========== System path =================="
echo "%_PATH%"
echo "========== filename =================="
echo "%filename%"
)

%filename% {{ arguments }} %*

ENDLOCAL



